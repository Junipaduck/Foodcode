<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itwillbs.foodcode.mapper.ReviewMapper">
	<insert id="insertReview">
		<selectKey keyProperty="review_idx" resultType="int" order="BEFORE">
			SELECT IFNULL(MAX(review_idx), 0) FROM review
		</selectKey>
		INSERT INTO review
			VALUES (
				#{review_idx} + 1 -- 리뷰 글번호
				,#{review_content} -- 리뷰 내용
				,#{review_star} -- 리뷰 평점
				,now() -- 리뷰 작성일
				,#{review_idx} + 1 -- 리뷰 참조글번호
				,1 -- review_re_lev
				,1 -- review_re_seq
				,#{store_idx} -- store_idx
				,#{member_id} -- member_id
				,1 -- pay_idx
				,#{review_file} -- 리뷰 이미지 파일
				,#{review_file_path}
			)
	</insert>
	
	<update id="updateReview">
		UPDATE review 
			SET
			review_content = #{review_content}
			,review_star = #{review_star}
			,review_file = #{review_file}
			WHERE
			review_idx = #{review_idx}
	</update>
	
	<delete id="deleteReview">
		DELETE 
			FROM review
			WHERE review_idx = #{review_idx}
	</delete>
	
	<!-- 리뷰 목록 조회 -->
	<select id="selectReviewList" resultType="com.itwillbs.foodcode.vo.ReviewVO">
		SELECT 
			r.review_idx
			, r.member_id 
			, s.store_name 
			, r.review_content 
			, r.review_file 
			, r.review_star 
			, r.review_date
			, s.store_idx
			, r.review_re_ref
			, r.review_re_lev
			, r.review_re_seq
			, r.pay_idx
			, r.review_file_path 
			FROM review r JOIN store s
			ON r.store_idx = s.store_idx
			<if test="!searchKeyword.equals('')">
				WHERE 
				<choose>
					<when test="searchType.equals('content')">
						review_content LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
				</choose>
			</if>
			ORDER BY
				review_re_ref DESC
				, review_re_seq ASC
			LIMIT
				#{startRow}
				,#{listLimit}
	</select>
	
	<!-- 글 목록 총 갯수 조회 -->
	<select id="selectReviewListCount" resultType="int">
		SELECT COUNT(*)
			FROM review 
			<if test="!searchKeyword.equals('')">
				WHERE
				<choose>
					<when test="searchType.equals('content')">
						review_content LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
				</choose>
			</if>
	</select>
	
	<!-- 특정 아이디 리뷰 목록 조회용 -->
	<select id="customerReviewList" resultType="com.itwillbs.foodcode.vo.ReviewVO">
		   SELECT *
            	FROM review
            	WHERE member_id = #{member_id}
           		ORDER BY 
                	review_re_ref
            	LIMIT 
                10
	</select>
	
	<!-- 가게 상세 페이지 리뷰조회 - 임시용 -->
	<select id="reviewList" resultType="com.itwillbs.foodcode.vo.ReviewVO">
	   SELECT *
            FROM review
         	ORDER BY 
               	review_re_ref
           	LIMIT 
            10
	</select>
	
	<select id="selectMemberList" resultType="com.itwillbs.foodcode.vo.MemberVO">
		SELECT *
			FROM member
	</select>
	
	<select id="selectOwnerReviewList" resultType="com.itwillbs.foodcode.vo.ReviewVO">
		SELECT 
			r.review_idx
			, s.store_name 
			, r.review_content 
			, r.review_file 
			, r.review_star 
			, r.review_date
			, s.store_idx
			, r.review_re_ref
			, r.review_re_lev
			, r.review_re_seq
			, r.pay_idx
			, r.review_file_path 
			, s.member_id
			FROM review r JOIN store s
			ON r.store_idx = s.store_idx
			<if test="!searchKeyword.equals('')">
				WHERE 
				<choose>
					<when test="searchType.equals('content')">
						review_content LIKE CONCAT('%', #{searchKeyword}, '%')
					</when>
				</choose>
			</if>
			ORDER BY
				review_re_ref DESC
				, review_re_seq ASC
			LIMIT
				#{startRow}
				,#{listLimit}
	</select>
	
	<!-- 리뷰 수정 시 파일 삭제 -->
	<delete id="deleteReiviewFile">
		UPDATE review
			SET
				review_file = ''
				, review_file_path = ''
			WHERE
				review_idx = #{review_idx}
	</delete>
</mapper>






















































